<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->


    <!-- Queries that return RNA primary keys (for use in questions and nested records.). -->

    <querySet name="RnaIds" queryType="id">
        <processQuery name="BySimilarity" displayName="WS Test" 
                 processName="org.apidb.apicomplexa.wsfplugin.ncbiblast.NcbiBlastPlugin">
             <paramRef ref="params.Application"/>
             <paramRef ref="params.Database"/>
             <paramRef ref="params.Sequence"/>
             <wsColumn name="na_sequence_id" width="100" wsName="Identifier"/>
             <wsColumn name="TabularRow" width="1000"/>
             <wsColumn name="Alignment" width="3000"/>
             <wsColumn name="Header" width="1000"/>
             <wsColumn name="Footer" width="1000"/>

       </processQuery>

        <sqlQuery name="ByNumSeqs" isCacheable="true">
            <paramRef ref="params.NumSeqs" default="10"/>
            <paramRef ref="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="score"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct a.na_sequence_id, '@project_id@' || '' AS project_id,
                           a.number_of_contained_sequences as score
                    from WDKTestAssembly a
                    where a.number_of_contained_sequences > $$NumSeqs$$
                    and a.taxon_id in ($$ApiTaxon$$)
                ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="Ortholog">
            <paramRef ref="params.rna_answer" />
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select ase.na_sequence_id
                    from WDKTestAssembly ase, 
                         $$rna_answer$$ r
                    where ase.na_sequence_id = r.na_sequence_id
                ]]>
            </sql>
        </sqlQuery>
      
        <sqlQuery name="ByDbESTLib">
            <paramRef ref="params.NumEstLibs" default="2"/>
            <paramRef ref="params.AssemblyConsistency" default="85"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct aseq.assembly_na_sequence_id as na_sequence_id
                    from WDKTestEst est, WDKTestLibrary lib,
                         WDKTestAssemblySequence aseq, WDKTestAssembly a
                    where lib.library_id = est.library_id 
                    and est.na_sequence_id = aseq.na_sequence_id 
                    and aseq.assembly_na_sequence_id = a.na_sequence_id
                    and aseq.assembly_na_sequence_id is not NULL 
                    and a.assembly_consistency > $$AssemblyConsistency$$
                    group by aseq.assembly_na_sequence_id 
                    having count (distinct lib.dbest_id) >= $$NumEstLibs$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="EstParent">
            <column name="na_sequence_id"/>
            <column name="est_id"/>
            <column name="project_id"/>
            <sql>
                   select a.na_sequence_id AS est_id, '@PROJECT_ID@' || '' AS project_id
                   from WDKTestAssembly a, WDKTestAssemblySequence aseq
                        where aseq.assembly_na_sequence_id = a.na_sequence_id
            </sql>
        </sqlQuery>

    </querySet>


    <!-- Queries that return EST primary keys (for use in questions). -->

    <querySet name="EstIds" queryType="id">
        <sqlQuery name="ByEstLib">
            <paramRef ref="params.EstLib"/>
            <column name="est_id"/>
            <sql>
               <!-- union with self for federation simulation -->
               (select distinct e.est_id
                  from WDKTestEst e, WDkTestLibrary l
               where e.library_id = l.library_id
               and l.library_id in ($$EstLib$$))
               UNION
               (select distinct e.est_id
               from WDKTestEst e, WDkTestLibrary l
               where e.library_id = l.library_id
               and l.library_id in ($$EstLib$$))
            </sql>
        </sqlQuery>  
    
        <sqlQuery name="NullAttributeEsts">

            <column name="est_id"/>
            <sql>
              <![CDATA[
               select est_id from WdkTestEst e 
               where e.est_id > 9644240 and est_id < 9644245
              ]]>
            </sql>
         </sqlQuery>
    </querySet>


    <!-- Queries that return ZIP primary keys (for use in questions). -->

    <querySet name="ZipIds" queryType="id">
        <sqlQuery name="ByZipCode">
            <paramRef ref="params.ZipCode"/>
            <column name="zip_code"/>
            <sql>
               select z.zip_code, '@PROJECT_ID@' || '' AS project_id
               from WDKTestZipCode z
               where z.zip_code = $$ZipCode$$
            </sql>
        </sqlQuery>  

        <sqlQuery name="ByAreaCode">
            <paramRef ref="params.AreaCode"/>
            <column name="zip_code"/>
            <sql>
               select z.zip_code, '@PROJECT_ID@' || '' AS project_id
               from WDKTestZipCode z
               where z.area_code = $$AreaCode$$
            </sql>
        </sqlQuery>  
    </querySet>
    

    <!-- Queries that retrieve attributes of RNAs -->
    
    <querySet name="RnaAttributes" queryType="attribute">

        <sqlQuery name="GeneAttrs">
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="taxon_name"/>
            <column name="isoform_count"/>
            <sql>
                <![CDATA[
                select a.na_sequence_id, '@PROJECT_ID@' || '' AS project_id,
                       tn.name as taxon_name, 
                       count(*) as isoform_count
                from WDKTestAssembly a, WDKTestTaxonName tn, WDKTestAssemblySequence aseq
                where a.taxon_id = tn.taxon_id
                  and a.na_sequence_id = aseq.assembly_na_sequence_id
                group by a.na_sequence_id, tn.name
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="AssemblyAttrs">
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="assembly_consistency"/>
            <column name="contains_mrna"/>
            <column name="number_of_contained_sequences"/>
            <column name="sequence"/>
            <sql>
                select a.na_sequence_id, '@PROJECT_ID@' || '' AS project_id,
                       a.assembly_consistency, 
                       a.contains_mrna,
                       a.number_of_contained_sequences,
                       a.sequence
                from WDKTestAssembly a, WDKTestTaxonName tn 
                WHERE a.taxon_id = tn.taxon_id 
            </sql>
        </sqlQuery>
    </querySet>


    <!-- Queries that retrieve tables belonging to RNAs  -->
    
    <querySet name="RnaTables" queryType="table">
        <sqlQuery name="ConstituentEsts" displayName="Constituent ESTs">
            <column name="est_id"/>
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="sequence_start"/>
            <column name="sequence_end"/>
            <column name="quality_start"/>
            <column name="quality_end" />
            <sql>
                select aseq.na_sequence_id, '@PROJECT_ID@' || '' AS project_id,
                       aseq.na_sequence_id as est_id,
                       'DT.' || a.na_sequence_id as source_id, aseq.sequence_start,
                       aseq.sequence_end, aseq.quality_start, aseq.quality_end 
                from WDKTestAssemblySequence aseq, WDKTestAssembly a
                where a.na_sequence_id = aseq.assembly_na_sequence_id
            </sql>
        </sqlQuery>

        <sqlQuery name="SimpleEstIds">
             <column name="est_id"/>
             <column name="na_sequence_id"/>
             <column name="project_id"/>
             <!-- it's important to has a dymanic string as 'string' || '', 
                  in order to cast it into text type -->
             <sql>
                select est.est_id, est.na_sequence_id, '@PROJECT_ID@' || '' AS project_id
                from WDKTestAssemblySequence aseq, WDKTestAssembly a, WDKTestEst est
                where a.na_sequence_id = aseq.assembly_na_sequence_id
                  and est.na_sequence_id = aseq.na_sequence_id
             </sql>
        </sqlQuery>

    </querySet>
    

    <!-- Queries that retrieve attributes of ESTs -->
    
    <querySet name="EstAttributes" queryType="attribute">

        <sqlQuery name="EstAttrs">
            <column name="est_id"/>
            <column name="project_id"/>
            <column name="na_sequence_id"/>
            <column name="source_id"/>
            <sql>
                <!-- union with self for federation simulation -->
                select e.est_id, '@PROJECT_ID@' || '' AS project_id,
                       e.accession as source_id, 
                       e.na_sequence_id
                from WDKTestEst e
            </sql>
        </sqlQuery>

        <sqlQuery name="NullAttrs">
            <column name="est_id"/>
            <column name="project_id"/>
            <column name="assembly_id"/>
            <sql>
                select e.est_id, '@PROJECT_ID@' || '' AS project_id,
                       a.na_sequence_id as assembly_id
                from WDKTestEst e, 
                     WDKTestAssemblySequence aseq, 
                     WdkTestAssembly a
                where e.na_sequence_id = aseq.na_sequence_id
                  and aseq.assembly_na_sequence_id = a.na_sequence_id
            </sql>
        </sqlQuery>


        <sqlQuery name="LibAttrs">
            <column name="est_id"/>
            <column name="project_id"/>
            <column name="dbest_name"/>
            <column name="anatomy_id"/>
            <sql>
                select e.est_id, '@PROJECT_ID@' || '' AS project_id,
                       l.dbest_name, 
                       l.anatomy_id 
                from WDKTestEst e, 
                     WDKTestLibrary l 
                where e.library_id = l.library_id 
            </sql>
        </sqlQuery>
    </querySet>

    <!-- Queries that retrieve attributes of ESTs -->
    
    <querySet name="ZipAttributes" queryType="attribute">
        <sqlQuery name="ZipAttrs">
            <column name="zip_code"/>
            <column name="project_id"/>
            <column name="city"/>
            <column name="state"/>
            <column name="area_code"/>
            <sql>
                select z.zip_code, '@PROJECT_ID@' || '' AS project_id,
                       z.city, z.state, z.area_code 
                from WDKTestZipCode z
            </sql>
        </sqlQuery>
    </querySet>

    <!-- queries that return controlled vocabulary terms -->

    <querySet name="VocabQueries" queryType="vocab">
        <!-- a query that returns a list of Apicomplexon taxons -->
        <sqlQuery name="ApiTaxon" isCacheable="true">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct name as term, taxon_id as internal
                from WDKTestTaxonName
                where name in ('Neospora caninum', 'Plasmodium falciparum', 'Eimeria tenella',
                               'Plasmodium yoelii', 'Sarcocystis neurona', 'Toxoplasma gondii')
                order by internal desc
            </sql>
        </sqlQuery>

        <!-- a query that returns a list of EST Libraries -->
        <sqlQuery name="EstLib">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct dbest_name as term, library_id as internal
                from WDKTestLibrary where dbest_name like 'N%'
            </sql>
        </sqlQuery>

    </querySet>


    <!-- Queries that retrieve attributes or tables for data dumping records -->
    
    <querySet name="DataDumpQueries" queryType="attribute">

        <sqlQuery name="RnaGff" isCacheable="true">
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct a.na_sequence_id
                    from WDKTestAssembly a
                ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="RnaGffAttrs">
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="seqid"/>
            <column name="source"/>
            <column name="type"/>
            <column name="fstart"/>
            <column name="fend"/>
            <column name="score"/>
            <column name="strand"/>
            <column name="phase"/>
            <column name="attr_id"/>
            <column name="attr_name"/>
            <column name="attr_description"/>
            <sql>
                select a.na_sequence_id AS seqid, '@PROJECT_ID@' || '' AS project_id,
                       'WDKTemplate' as source,
                       'templateRNA' as type,
                       10  as fstart,
                       10  + 5 as fend,
                       '.' as score, '.' as strand, '.' as phase,
                       a.na_sequence_id as attr_id,
                       'aTemplateRna' as attr_name,
                       'Rna of taxon ' || taxon_id as attr_description
                from WDKTestAssembly a
            </sql>
        </sqlQuery>

        <sqlQuery name="RnaEsts" displayName="Constituent ESTs">
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <column name="seqid"/>
            <column name="source"/>
            <column name="type"/>
            <column name="fstart"/>
            <column name="fend"/>
            <column name="score"/>
            <column name="strand"/>
            <column name="phase"/>
            <column name="attr_id"/>
            <column name="attr_name"/>
            <column name="attr_parent"/>
            <column name="attr_description"/>
            <sql>
                select a.na_sequence_id as seqid, '@PROJECT_ID@' || '' AS project_id,
                       'WDKTemplate' as source,
                       'templateRNA' as type,
                       10  as fstart,
                       10 + 5 as fend,
                       '.' as score, '.' as strand, '.' as phase,
                       aseq.na_sequence_id as attr_id,
                       'aTemplateEst' as attr_name,
                       a.na_sequence_id as attr_parent,
                       aseq.sequence_start || ':' || aseq.sequence_end as attr_description
                from WDKTestAssemblySequence aseq, WDKTestAssembly a
                where a.na_sequence_id = aseq.assembly_na_sequence_id
            </sql>
        </sqlQuery>

    </querySet>

    
    <querySet name="SummaryQueries" queryType="summary">

        <sqlQuery name="RnaSummaryQuery" isCacheable="false">
            <paramRef ref="params.sample_sum_row"/>
            <paramRef ref="params.sample_sum_column"/>
            <paramRef ref="params.rna_answer"/>
            <column name="na_sequence_id"/>
            <column name="project_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    SELECT na_sequence_id
                    FROM $$rna_answer$$ a
                ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="EstSummaryQuery" isCacheable="false">
            <paramRef ref="params.sample_sum_row"/>
            <paramRef ref="params.sample_sum_column"/>
            <paramRef ref="params.est_answer"/>
            <column name="est_id"/>
            <column name="project_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    SELECT est_id, project_id
                    FROM $$est_answer$$ a
                ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="ZipSummaryQuery" isCacheable="false">
            <paramRef ref="params.sample_sum_row"/>
            <paramRef ref="params.sample_sum_column"/>
            <paramRef ref="params.zip_answer"/>
            <column name="zip_code"/>
            <column name="project_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    SELECT zip_code, project_id
                    FROM $$zip_answer$$ a
                ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="GffSummaryQuery" isCacheable="false">
            <paramRef ref="params.sample_sum_row"/>
            <paramRef ref="params.sample_sum_column"/>
            <paramRef ref="params.gff_answer"/>
            <column name="seqid"/>
            <column name="project_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    SELECT seqid, project_id
                    FROM $$gff_answer$$ a
                ]]>
            </sql>
        </sqlQuery>  

    </querySet>
</wdkModel>
